{% extends "base.html" %}

{% block title %}Students - Teacher{% endblock %}

{% block content %}

TEST123
<div class="dashboard">
    <div class="page-header">
        <h1><i class="fas fa-users"></i> Students</h1>
        <p>List of students in your department.</p>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="table-toolbar" style="margin-bottom: 1rem; display: flex; gap: 0.75rem; align-items: center; justify-content: space-between;">
                <div class="toolbar-left" style="flex: 1;">
                    <input type="text" id="studentSearch" class="form-control" placeholder="Search by name or ID...">
                </div>
                <div class="toolbar-right" style="width: 180px;">
                    <select id="yearFilter" class="form-control">
                        <option value="">Filter by level</option>
                        {% for level in range(7,13) %}
                        <option value="{{ level }}">Grade {{ level }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Student ID</th>
                            <th>Year Level</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in students %}
                        <tr>
                            <td>
                                <div class="list-item">
                                    <div class="list-avatar">
                                        {# Placeholder avatar / initials. Replace src when you have real student images #}
                                        {% if s.avatar %}
                                        <img src="/{{ s.avatar }}" alt="{{ s.first_name }} {{ s.last_name }}" class="avatar-circle">
                                        {% else %}
                                        <span class="avatar-circle">{{ (s.first_name[:1] ~ s.last_name[:1])|upper }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="list-info">
                                        <h6>{{ s.first_name }} {{ s.last_name }}</h6>
                                        <p>
                                            Grade {{ s.year_level }}
                                            <span class="badge badge-success">Active</span>
                                        </p>
                                    </div>
                                </div>
                            <td>{{ s.student_id }}</td>
                            <td>Grade {{ s.year_level }}</td>
                            <td class="text-right">
                                <div class="btn-group-inline">
                                    <!-- View profile (read-only) -->
                                    <a href="{{ url_for('teacher_view_student', student_id=s.id) }}"
                                       class="btn btn-xs btn-primary">
                                        View
                                    </a>

                                    <!-- Archive to inactive (soft) - open reason modal -->
                                    <button type="button"
                                            class="btn btn-xs btn-warning"
                                            onclick="openArchiveModal({{ s.id }});">
                                        Archive
                                    </button>

                                    <!-- Mark permanently_deleted and move to archived -->
                                    <form method="post"
                                          action="{{ url_for('teacher_delete_student', student_id=s.id) }}"
                                          style="display:inline;"
                                          onsubmit="return confirm('Mark this student as permanently deleted and move to archived?');">
                                        <button type="submit" class="btn btn-xs btn-danger">
                                            Delete
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center">No students found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Archive Reason Modal -->
<div id="archiveReasonModal" class="popup-alert" aria-hidden="true">
    <div class="popup-backdrop" onclick="closeArchiveModal()"></div>
    <div class="popup-dialog">
        <button type="button" class="popup-close" onclick="closeArchiveModal()">&times;</button>
        <div class="popup-icon"><i class="fas fa-box-archive"></i></div>
        <h3 class="popup-title">Archive Student</h3>
        <p class="popup-message">Please select the reason why this student is being archived.</p>
        <form id="archiveReasonForm" method="post">
            <input type="hidden" name="student_id" id="archiveStudentId" value="">
            <div class="form-group">
                <label for="reason_type">Reason</label>
                <select name="reason_type" id="reason_type" class="form-control">
                    <option value="Transferred to another school">Transferred to another school</option>
                    <option value="Stopped schooling">Stopped schooling</option>
                    <option value="Graduated early">Graduated early</option>
                    <option value="Disciplinary reason">Disciplinary reason</option>
                    <option value="Other personal reason">Other personal reason</option>
                </select>
            </div>
            <div class="form-actions" style="display:flex; justify-content:flex-end; gap:0.5rem; margin-top:1rem;">
                <button type="button" class="btn btn-secondary" onclick="closeArchiveModal()">Cancel</button>
                <button type="submit" class="btn btn-warning">Archive</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openArchiveModal(studentId) {
        const modal = document.getElementById('archiveReasonModal');
        const form = document.getElementById('archiveReasonForm');
        document.getElementById('archiveStudentId').value = studentId;
        // reset select
        document.getElementById('reason_type').value = 'Transferred to another school';
        // set correct action url
        form.action = '{{ url_for('teacher_archive_student', student_id=0) }}'.replace('0', studentId);
        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
    }

    function closeArchiveModal() {
        const modal = document.getElementById('archiveReasonModal');
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
    }

    (function () {
        const searchInput = document.getElementById('studentSearch');
        const yearFilter = document.getElementById('yearFilter');
        const rows = Array.from(document.querySelectorAll('table.data-table tbody tr'));

        function normalize(text) {
            return (text || '').toString().toLowerCase();
        }

        function applyFilters() {
            const term = normalize(searchInput.value);
            const year = yearFilter.value;

            rows.forEach(row => {
                const nameCell = row.querySelector('.list-info h6');
                const idCell = row.querySelector('td:nth-child(2)');
                const yearCell = row.querySelector('td:nth-child(3)');
                if (!nameCell || !idCell || !yearCell) return;

                const nameText = normalize(nameCell.textContent);
                const idText = normalize(idCell.textContent);
                const yearText = normalize(yearCell.textContent.replace('grade', ''));

                const matchesSearch = !term || nameText.includes(term) || idText.includes(term);
                const matchesYear = !year || yearText.includes(year.toLowerCase());

                row.style.display = (matchesSearch && matchesYear) ? '' : 'none';
            });
        }

        if (searchInput && yearFilter) {
            searchInput.addEventListener('input', applyFilters);
            yearFilter.addEventListener('change', applyFilters);
        }
    })();
</script>
{% endblock %}
