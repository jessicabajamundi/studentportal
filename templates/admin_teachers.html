{% extends "base.html" %}

{% block title %}Admin - Manage Teachers{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="fas fa-user-tie"></i> Manage Teachers</h1>
        <p>Create teacher accounts and view existing teachers.</p>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <div class="dashboard-section" style="margin-top:1.5rem;">
        <h2><i class="fas fa-user-plus"></i> Create Teacher</h2>
        <p class="section-subtitle">Fill out the fields below to add a new teacher account.</p>
        <form method="POST" class="login-form" action="{{ url_for('admin_teachers') }}">
            <div class="form-grid">
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" name="username" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email">
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <input type="password" name="password" required>
                </div>
                <div class="form-group">
                    <label>First Name *</label>
                    <input type="text" name="first_name" required>
                </div>
                <div class="form-group">
                    <label>Last Name *</label>
                    <input type="text" name="last_name" required>
                </div>
                <div class="form-group">
                    <label>Department</label>
                    <select name="department">
                        <option value="">-- Select Department --</option>
                        {% for dept in departments %}
                        <option value="{{ dept.course_code }}">{{ dept.course_code }} - {{ dept.course_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div style="margin-top:1rem;">
                <button class="btn btn-primary"><i class="fas fa-user-plus"></i> Create Teacher</button>
            </div>
        </form>
    </div>

    {% if teachers %}
    <div class="dashboard-section">
        <h2><i class="fas fa-list"></i> Existing Teachers</h2>
        <div class="table-filters" style="display:flex;gap:1rem;align-items:center;margin-bottom:0.75rem;flex-wrap:wrap;">
            <div class="form-group" style="margin:0;flex:1 1 220px;">
                <input type="text" id="teacherSearch" placeholder="Search by name, email, or username" style="width:100%;">
            </div>
            <div class="form-group" style="margin:0;flex:0 0 220px;">
                <select id="teacherDeptFilter" style="width:100%;">
                    <option value="">All Departments</option>
                    {% for dept in departments %}
                    <option value="{{ dept.course_code }}">{{ dept.course_code }} - {{ dept.course_name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Teacher</th>
                        <th>Email</th>
                        <th>Username</th>
                        <th>Department</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in teachers %}
                    <tr>
                        <td>
                            <div class="list-item">
                                <div class="list-avatar">
                                    {% if t.avatar %}
                                    <img src="/{{ t.avatar }}" alt="{{ t.first_name }} {{ t.last_name }}" class="avatar-circle">
                                    {% else %}
                                    <span class="avatar-circle">{{ (t.first_name[:1] ~ t.last_name[:1])|upper }}</span>
                                    {% endif %}
                                </div>
                                <div class="list-info">
                                    <h6>{{ t.first_name }} {{ t.last_name }}</h6>
                                    <p>{{ t.department or 'No department' }}</p>
                                </div>
                            </div>
                        </td>
                        <td>{{ t.email or '—' }}</td>
                        <td>{{ t.username }}</td>
                        <td>{{ t.department or '—' }}</td>
                        <td class="text-right">
                            <form method="POST" action="{{ url_for('admin_archive_teacher', teacher_id=t.id) }}" style="display:inline;" onsubmit="return confirm('Archive this teacher? They will be hidden but can be restored.');">
                                <button type="submit" class="btn btn-xs btn-warning">Archive</button>
                            </form>
                            <form method="POST" action="{{ url_for('admin_delete_teacher', teacher_id=t.id) }}" style="display:inline;" onsubmit="return confirm('Permanently delete this teacher? This cannot be undone.');">
                                <button type="submit" class="btn btn-xs btn-danger">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('teacherSearch');
        const deptSelect = document.getElementById('teacherDeptFilter');
        const table = document.querySelector('.data-table');
        if (!table) return;

        const rows = Array.from(table.querySelectorAll('tbody tr'));

        function applyFilters() {
            const search = (searchInput?.value || '').toLowerCase().trim();
            const dept = (deptSelect?.value || '').toLowerCase().trim();

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const name = (cells[0]?.textContent || '').toLowerCase();
                const email = (cells[1]?.textContent || '').toLowerCase();
                const username = (cells[2]?.textContent || '').toLowerCase();
                const department = (cells[3]?.textContent || '').toLowerCase();

                const matchesSearch = !search || (
                    name.includes(search) ||
                    email.includes(search) ||
                    username.includes(search) ||
                    department.includes(search)
                );

                const matchesDept = !dept || department.includes(dept);

                row.style.display = (matchesSearch && matchesDept) ? '' : 'none';
            });
        }

        if (searchInput) searchInput.addEventListener('input', applyFilters);
        if (deptSelect) deptSelect.addEventListener('change', applyFilters);
    });
</script>
{% endblock %}